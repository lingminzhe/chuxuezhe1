<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.grgbanking.counter.iam.dao.SysUserDao">

    <resultMap type="com.grgbanking.counter.iam.api.vo.SysUserVo" id="baseMap">
        <id property="id" column="ID"/>
        <result property="username" column="USERNAME"/>
        <result property="email" column="EMAIL"/>
        <result property="joinOrgName" column="ORG_NAME"/>
        <result property="isEnabled" column="IS_ENABLED"/>
        <result property="joinOrgId" column="ORG_ID"/>
        <result property="sex" column="SEX"/>
        <result property="email" column="email"/>
        <result property="mobileTelephone" column="MOBILE_TELEPHONE"/>
        <result property="creationDate" column="creationDate"/>
    </resultMap>

    <update id="updateUser">
        UPDATE SYS_USER
        <trim prefix="set" suffixOverrides=",">
            <if test="user.name !=null and user.name!=''">
                name =#{user.name},
            </if>
            <if test="user.isEnabled !=null and user.isEnabled!=''">
                is_enabled =#{user.isEnabled},
            </if>
            <if test="user.sex !=null and user.sex!=''">
                sex =#{user.sex},
            </if>
            <if test="user.email !=null and user.email!=''">
                email =#{user.email},
            </if>
            <if test="user.mobileTelephone !=null and user.mobileTelephone!=''">
                mobile_telephone =#{user.mobileTelephone},
            </if>
            <if test="user.lastUpdatedBy !=null and user.lastUpdatedBy!=''">
                last_updated_by =#{user.lastUpdatedBy},
            </if>
            <if test="user.lastUpdateDate !=null ">
                last_update_date =#{user.lastUpdateDate},
            </if>
            <if test="user.nationality !=null and user.nationality!=''">
                nationality =#{user.nationality},
            </if>
            <if test="user.credentialsType !=null and user.credentialsType!=''">
                CREDENTIALS_TYPE =#{user.credentialsType},
            </if>
            <if test="user.credentialsNumber !=null and user.credentialsNumber!=''">
                CREDENTIALS_NUMBER =#{user.credentialsNumber},
            </if>
            <if test="user.homeAddress !=null and user.homeAddress!=''">
                home_address =#{user.homeAddress}
            </if>
        </trim>
        WHERE id = #{user.id}
    </update>

    <update id="restPassword">
       UPDATE SYS_USER set PASSWORD=#{user.password} where username=#{user.username}
    </update>

    <select id="listPage" parameterType="com.grgbanking.counter.iam.api.bo.SysUserQueryBo"
            resultType="com.grgbanking.counter.iam.api.vo.SysUserQueryVo">
        SELECT U.*,
        SYS.NAME join_org_name,
        SYS.ID join_org_id,
        SYS.I18N_CODE join_org_i18n_code
        FROM
        SYS_USER U
        INNER JOIN SYS_ORG_USER ORG ON U.ID = ORG.USER_ID AND ORG.IS_LEADER='0' <if test="userType!=null">AND (U.TYPE != #{userType} OR U.TYPE IS NULL)</if>
        INNER JOIN SYS_ORG SYS ON ORG.ORG_ID = SYS.ID
        <where>
            <if test="userId!=null">
                EXISTS ( SELECT
                1
                FROM
                SYS_ORG_USER R
                WHERE
                R.ORG_ID=SYS.ID
                AND R.IS_LEADER = '1'
                AND R.USER_ID =#{userId}
                )
            </if>
            <if test="orgPath!=null and orgPath!=''">
                AND SYS.ORG_PATH LIKE CONCAT( #{ orgPath }, '%' )
            </if>
            <if test="vo.username !=null and vo.username !='' ">
                AND U.USERNAME LIKE CONCAT('%',CONCAT(#{vo.username}, '%'))
            </if>
            <if test="vo.name !=null and vo.name !='' ">
                AND U.NAME LIKE CONCAT('%',CONCAT(#{vo.name}, '%'))
            </if>
            <if test="vo.isEnabled !=null and vo.isEnabled !='' ">
                AND U.IS_ENABLED LIKE CONCAT(#{vo.isEnabled}, '%')
            </if>
        </where>
        ORDER BY U.USERNAME ASC
    </select>

    <select id="queryAllMenuId" resultType="Long">
		select distinct rm.menu_id from sys_user_role ur
			LEFT JOIN sys_role_menu rm on ur.role_id = rm.role_id
		where ur.user_id = #{userId}
	</select>
    <select id="getAuthMessageUsers" resultType="com.grgbanking.counter.iam.api.vo.SysUserVo">
        SELECT
        G.*
        FROM
        SYS_USER G
        INNER JOIN SYS_ORG_USER O ON G.ID = O.USER_ID
        <where>
            <if test="status!=null and status !=''">
                AND G.IS_ENABLED = #{status}
            </if>
            <if test="isLeader !=null and isLeader !=''">
                AND O.is_Leader = #{isLeader}
            </if>
            <if test="orgId !=null and orgId !=''">
                AND O.ORG_ID = #{orgId}
            </if>

        </where>
    </select>

    <select id="queryAllAuthority" resultType="java.lang.String" >
		select distinct a.AUTHORITY from SYS_USER u
        inner join SYS_ROLE_USER ru on u.ID = ru.USER_ID
		inner join SYS_ROLE r on r.ID = ru.ROLE_ID
	    inner join SYS_ROLE_MENU rm on rm.ROLE_ID = r.ID
	    inner join SYS_MENU m on m.ID = rm.MENU_ID
	    inner join SYS_MENU_AUTHORITY ma on ma.MENU_ID = m.ID
	    inner join SYS_AUTHORITY a on a.ID = ma.AUTHORITY_ID
		where u.ID = #{userId} and r.IS_ENABLED = #{isEnabled} and m.IS_ENABLED = #{isEnabled} and a.IS_ENABLED = #{isEnabled} and rm.IS_LEADER = #{isLeader}
	</select>
    <select id="queryAuthorityListByUserId" resultType="com.grgbanking.counter.iam.entity.SysAuthorityEntity" >
		select distinct a.* from SYS_USER u
        inner join SYS_ROLE_USER ru on u.ID = ru.USER_ID
		inner join SYS_ROLE r on r.ID = ru.ROLE_ID
	    inner join SYS_ROLE_MENU rm on rm.ROLE_ID = r.ID
	    inner join SYS_MENU m on m.ID = rm.MENU_ID
	    inner join SYS_MENU_AUTHORITY ma on ma.MENU_ID = m.ID
	    inner join SYS_AUTHORITY a on a.ID = ma.AUTHORITY_ID
		where u.ID = #{userId} and r.IS_ENABLED = #{isEnabled} and m.IS_ENABLED = #{isEnabled} and a.IS_ENABLED = #{isEnabled} and rm.IS_LEADER = #{isLeader}
	</select>
</mapper>
